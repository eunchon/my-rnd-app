import { useMemo, useSyncExternalStore } from 'react';

type Lang = 'en' | 'ko';
const STORE_KEY = 'lang';

let currentLang: Lang = (typeof window !== 'undefined' && (localStorage.getItem(STORE_KEY) as Lang)) || 'ko';
const listeners = new Set<() => void>();

export function setLang(lang: Lang) {
  currentLang = lang;
  if (typeof window !== 'undefined') localStorage.setItem(STORE_KEY, lang);
  listeners.forEach((l) => l());
}

export function getLang(): Lang {
  return currentLang;
}

export function useLang(): Lang {
  return useSyncExternalStore(
    (cb) => {
      listeners.add(cb);
      return () => listeners.delete(cb);
    },
    () => currentLang,
    () => currentLang
  );
}

const dict = {
  en: {
    app_title: 'R&D Request Portal',
    nav_dashboard: 'Dashboard',
    nav_list: 'Request List',
    nav_new: 'New Request',
    role_label: 'Role',
    search_placeholder: 'Search title/customer',
    filter_stage_all: 'All Stages',
    filter_area_all: 'All Areas',
    area_ct: 'CT',
    area_carm: 'C-Arm',
    area_ultra: 'Ultrasound',
    area_software: 'Software',
    th_title: 'Title',
    th_customer: 'Customer',
    th_area: 'Area',
    th_productArea: 'Product Area',
    th_category: 'Category',
    th_expected_rev: 'Expected Revenue',
    th_expectedRevenue: 'Expected Revenue',
    th_importance: 'Importance',
    th_stage: 'Stage',
    th_status: 'Status',
    th_created: 'Created',
    th_deadline: 'Deadline',
    loading: 'Loading...',
    list_subtitle: 'Check uploaded requests, skim summaries, click to read details.',
    list_total: 'Total',
    empty_list: 'No requests found.',
    kpi_total_requests: 'Total requests (YTD)',
    kpi_by_stage: 'By stage',
    kpi_deadline_risk: 'Deadline risk (7d)',
    filters_title: 'Filters',
    filter_from: 'From',
    filter_to: 'To',
    table_id: 'ID',
    table_title: 'Title',
    table_area: 'Area',
    table_customer: 'Customer',
    table_expected: 'Expected',
    table_deadline: 'Deadline',
    table_days_since: 'Days since submitted',
    chart_count: 'Count',
    chart_active: 'Active',
    card_top_keywords: 'Top Keywords (YTD)',
    card_rd_group_load: 'RD Group Load (active requests)',
    card_decision_pending: 'Decision pending (CONFIRM + CTO/CEO)',
    timeline_title: 'Timeline (submitted → customer deadline)',
    timeline_urgent: 'Urgent',
    timeline_urgent_window: 'Urgent window',
    timeline_max_rows: 'Max rows',
    timeline_axis_left: '0d',
    timeline_days_left: 'days left',
    legend_must: 'MUST',
    legend_should: 'SHOULD',
    legend_nice: 'NICE',
    importance_MUST: 'Must have',
    importance_SHOULD: 'Should have',
    importance_NICE: 'Nice to have',
    stages_IDEATION: 'IDEATION',
    stages_REVIEW: 'REVIEW',
    stages_CONFIRM: 'CONFIRM',
    stages_PROJECT: 'PROJECT',
    stages_REJECTED: 'REJECTED',
    stages_ASSIGNMENT: 'ASSIGNMENT',
    stages_DEVELOPMENT: 'DEVELOPMENT',
    stages_VALIDATION: 'VALIDATION',
    stages_PILOT: 'PILOT',
    stages_RELEASE: 'RELEASE',
    back_to_list: 'Back to list',
    detail_basic: 'Basic info',
    detail_keywords: 'Keywords',
    detail_groups: 'Related R&D groups / tech areas',
    detail_attachments: 'Attachments',
    detail_timeline: 'Stage timeline',
    // Form
    form_header_basic: 'Header: Basic Info',
    form_request_title: 'Request title',
    form_author: 'Author',
    form_author_placeholder: 'Enter name',
    form_job_title: 'Job title',
    form_sales_dept: 'Sales dept',
    form_customer_name: 'Customer/Hospital',
    form_region: 'Region/Country',
    form_customer_raw: 'Customer RAW data',
    form_customer_raw_text: 'Customer raw text',
    form_attachments_note: 'Attachments omitted in prototype.',
    form_structured_class: 'Structured classification',
    form_project_type: 'Project type',
    form_product_area: 'Product area',
    form_product_model: 'Product model',
    form_customer_deadline: 'Customer deadline',
    form_related_groups: 'Related R&D groups & technical areas',
    form_tech_note: 'Use simple keywords for tech tags.',
    form_sales_impact: 'Sales perspective: business impact',
    form_importance: 'Importance',
    form_expected_revenue: 'Expected revenue (KRW)',
    form_estimate_hard: 'Hard to estimate',
    form_keywords: 'Keywords',
    form_comma_sep: 'comma-separated',
    form_detail_duplicate: 'Detailed description, duplicate check',
    form_sales_summary: 'Sales summary',
    form_search_similar: 'Search similar requests',
    form_search_hint: 'same productArea + title/raw text LIKE',
    form_similar: 'Similar',
    form_submitted: 'Submitted',
    form_submit_request: 'Submit Request',
    form_fill_required: 'Fill required fields to enable',
    form_option_c_title: 'Priority/Regulatory/KPI (Option C)',
    form_rice: 'RICE (Reach/Impact/Confidence/Effort)',
    form_rice_hint: 'Score = (R*I*C)/E',
    form_regulatory: 'Regulatory/Compliance',
    form_regulatory_required: 'Regulatory impact',
    form_regulatory_notes: 'Regulatory notes',
    form_strategy_kpi: 'Strategy/Resources/KPI',
    form_alignment: 'Alignment',
    form_resource_weeks: 'Est. weeks',
    form_kpi_metric: 'KPI metric',
    form_kpi_target: 'KPI target',
    label_overdue: 'Overdue',
    pagination_prev: 'Prev',
    pagination_next: 'Next',
    pagination_page: 'Page',
  },
  ko: {
    app_title: 'R&D 요청 포털',
    nav_dashboard: '대시보드',
    nav_list: '요청 목록',
    nav_new: '신규 요청',
    role_label: '역할',
    search_placeholder: '제목/고객 검색',
    filter_stage_all: '전체 단계',
    filter_area_all: '전체 제품군',
    area_ct: 'CT',
    area_carm: 'C-Arm',
    area_ultra: '초음파',
    area_software: '소프트웨어',
    th_title: '제목',
    th_customer: '고객',
    th_area: '제품군',
    th_productArea: '제품군',
    th_category: '카테고리',
    th_expected_rev: '예상 매출',
    th_expectedRevenue: '예상 매출',
    th_importance: '중요도',
    th_stage: '단계',
    th_status: '상태',
    th_created: '생성일',
    th_deadline: '마감일',
    loading: '불러오는 중...',
    list_subtitle: '업로드된 요청을 확인하고 요약을 본 뒤 클릭해 자세히 읽습니다.',
    list_total: '총 개수',
    empty_list: '요청이 없습니다.',
    kpi_total_requests: '연간 총 요청',
    kpi_by_stage: '단계별',
    kpi_deadline_risk: '마감 임박(7일)',
    filters_title: '필터',
    filter_from: '시작일',
    filter_to: '종료일',
    table_id: 'ID',
    table_title: '제목',
    table_area: '제품군',
    table_customer: '고객',
    table_expected: '예상',
    table_deadline: '마감',
    table_days_since: '접수 후 경과일',
    chart_count: '건수',
    chart_active: '진행',
    card_top_keywords: '상위 키워드(올해)',
    card_rd_group_load: 'RD 그룹 부하(진행 요청)',
    card_decision_pending: '의사결정 대기(CTO/CEO)',
    timeline_title: '타임라인 (제출 → 고객 마감)',
    timeline_urgent: '긴급',
    timeline_urgent_window: '긴급 구간',
    timeline_max_rows: '최대 행수',
    timeline_axis_left: '0일',
    timeline_days_left: '잔여 일수',
    legend_must: 'MUST',
    legend_should: 'SHOULD',
    legend_nice: 'NICE',
    importance_MUST: '반드시 필요',
    importance_SHOULD: '가능하면 반영',
    importance_NICE: '있으면 좋음',
    stages_IDEATION: '아이데이션',
    stages_REVIEW: '리뷰',
    stages_CONFIRM: '승인 검토',
    stages_PROJECT: '프로젝트',
    stages_REJECTED: '반려',
    stages_ASSIGNMENT: '배정',
    stages_DEVELOPMENT: '개발',
    stages_VALIDATION: '검증',
    stages_PILOT: '파일럿',
    stages_RELEASE: '출시',
    back_to_list: '목록으로 돌아가기',
    detail_basic: '기본 정보',
    detail_keywords: '키워드',
    detail_groups: '관련 R&D 그룹 / 기술 영역',
    detail_attachments: '첨부파일',
    detail_timeline: '단계 타임라인',
    // Form
    form_header_basic: '기본 정보',
    form_request_title: '요청 제목',
    form_author: '작성자',
    form_author_placeholder: '이름을 입력하세요',
    form_job_title: '직책',
    form_sales_dept: '영업 부서',
    form_customer_name: '고객/병원명',
    form_region: '지역/국가',
    form_customer_raw: '고객 발화 원문',
    form_customer_raw_text: '고객 발화 원문',
    form_attachments_note: '첨부파일은 프로토타입에서 생략했습니다.',
    form_structured_class: '분류',
    form_project_type: '프로젝트 유형',
    form_product_area: '제품군',
    form_product_model: '제품 모델',
    form_customer_deadline: '고객 마감일',
    form_related_groups: '관련 R&D 그룹 & 기술 영역',
    form_tech_note: '기술 태그를 간단히 적어주세요.',
    form_sales_impact: '영업 관점 영향',
    form_importance: '중요도',
    form_expected_revenue: '예상 매출 (KRW)',
    form_estimate_hard: '산정 어려움',
    form_keywords: '키워드',
    form_comma_sep: '쉼표 구분',
    form_detail_duplicate: '상세 설명 / 중복 확인',
    form_sales_summary: '영업 요약',
    form_search_similar: '유사 요청 검색',
    form_search_hint: '동일 제품군 + 제목/원문 LIKE',
    form_similar: '유사 요청',
    form_submitted: '제출 완료',
    form_submit_request: '요청 제출',
    form_fill_required: '필수 입력을 채워주세요',
    form_option_c_title: '우선순위/규제/KPI (옵션)',
    form_rice: 'RICE (Reach/Impact/Confidence/Effort)',
    form_rice_hint: '점수 = (R*I*C)/E',
    form_regulatory: '규제/컴플라이언스',
    form_regulatory_required: '규제 영향 여부',
    form_regulatory_notes: '규제 메모',
    form_strategy_kpi: '전략/리소스/KPI',
    form_alignment: '정렬도',
    form_resource_weeks: '예상 투입 주',
    form_kpi_metric: 'KPI 지표',
    form_kpi_target: 'KPI 목표',
    label_overdue: '마감 초과',
    pagination_prev: '이전',
    pagination_next: '다음',
    pagination_page: '페이지',
  },
} as const;

export function useT() {
  const lang = useLang();
  return useMemo(() => {
    const d = dict[lang];
    return (key: keyof typeof dict['en']) => d[key] ?? String(key);
  }, [lang]);
}
