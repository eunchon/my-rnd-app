// Prisma SQLite schema for R&D Request Portal
generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id       String  @id @default(cuid())
  name     String
  dept     String
  role     String  // ADMIN, SALES, RD, EXEC
  email    String  @unique
  organization String?
  passwordHash String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  requests Request[]
}

model Request {
  id               String         @id @default(cuid())
  title            String
  customerName     String
  productArea      String
  productModel     String?
  category         String
  expectedRevenue  BigInt?
  importanceFlag   String
  submittedAt      DateTime       @default(now())
  customerDeadline DateTime
  currentStage     String
  currentStatus    String?
  createdByDept    String
  createdByUserId  String
  createdByName    String?
  createdBy        User           @relation(fields: [createdByUserId], references: [id])
  region           String?
  rawCustomerText  String
  salesSummary     String
  attachments      RequestAttachment[]
  keywords         RequestKeyword[]
  stageHistory     StageHistory[]
  rdGroups         RequestRDGroup[]
  techAreas        RequestTechArea[]
  stageTargets     RequestStageTarget[]
  stageTargetHistory RequestStageTargetHistory[]

  // Option C: prioritization, regulatory, KPI & planning fields
  riceReach              Int?
  riceImpact             Int?
  riceConfidence         Int?
  riceEffort             Int?
  riceScore              Float?
  regulatoryRequired     Boolean? @default(false)
  regulatoryRiskLevel    String?
  regulatoryNotes        String?
  strategicAlignment     Int?
  resourceEstimateWeeks  Int?
  kpiMetric              String?
  kpiTarget              Int?
  revenueEstimateStatus  String?
  revenueEstimateNote    String?
  influenceRevenue       Int?    @default(0)
  influenceCustomer      Int?    @default(0)
  influenceCustomization Int?    @default(0)
  influenceStrategy      Int?    @default(0)
  influenceTender        Int?    @default(0)
  influenceTotal         Int?    @default(0)
}

model StageHistory {
  id         String  @id @default(cuid())
  requestId  String
  request    Request @relation(fields: [requestId], references: [id])
  stage      String
  enteredAt  DateTime
  exitedAt   DateTime?
}

model RequestKeyword {
  id        String  @id @default(cuid())
  requestId String
  request   Request @relation(fields: [requestId], references: [id])
  keyword   String
}

model RDGroup {
  id       String  @id @default(cuid())
  name     String @unique
  category String?
  requests RequestRDGroup[]
}

model RequestRDGroup {
  id         String  @id @default(cuid())
  requestId  String
  rdGroupId  String
  role       String?
  request    Request @relation(fields: [requestId], references: [id])
  rdGroup    RDGroup @relation(fields: [rdGroupId], references: [id])
}

model RequestTechArea {
  id        String  @id @default(cuid())
  requestId String
  request   Request @relation(fields: [requestId], references: [id])
  groupName String  // e.g., 기구그룹, 전자그룹, 덴탈SW그룹
  code      String  // e.g., MECH_COVER, SW_UI
  label     String
}

model RequestAttachment {
  id        String  @id @default(cuid())
  requestId String
  request   Request @relation(fields: [requestId], references: [id])
  filename  String
  url       String?
}

model RequestStageTarget {
  id         String   @id @default(cuid())
  requestId  String
  request    Request  @relation(fields: [requestId], references: [id])
  stage      String
  targetDate DateTime
  setByUserId String?
  setByName   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([requestId, stage])
}

model RequestStageTargetHistory {
  id          String   @id @default(cuid())
  requestId   String
  request     Request  @relation(fields: [requestId], references: [id])
  stage       String
  previousTarget DateTime?
  newTarget     DateTime
  changedAt   DateTime @default(now())
  changedByUserId String?
  changedByName   String?
}
